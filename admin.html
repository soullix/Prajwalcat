<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Receipt Generator | Sarvadnya Caterers</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .font-great-vibes {
            font-family: 'Great Vibes', cursive;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem !important;
            }

            .receipt {
                font-size: 0.875rem;
            }

            .receipt h1 {
                font-size: 1.5rem !important;
            }

            .receipt table {
                font-size: 0.75rem;
            }

            .receipt th, .receipt td {
                padding: 0.25rem !important;
            }

            /* Touch-friendly buttons */
            button, a.bg-red-500, a.bg-blue-500, a.bg-yellow-500 {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Stack navigation vertically on mobile */
            .flex-col {
                flex-direction: column !important;
            }

            /* Full width forms on mobile */
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .receipt {
                max-width: 95%;
                margin: 0 auto;
            }
        }

        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .receipt {
                box-shadow: none !important;
                border: 1px solid #333 !important;
                max-width: 100%;
                page-break-inside: avoid;
            }

            /* Ensure images print */
            img {
                max-width: 100%;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            /* Keep table formatting on print */
            table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="font-great-vibes text-5xl text-purple-600 mb-2">Sarvadnya Caterers</h1>
                <p class="text-gray-600">Admin Access</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" id="username" required
                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                        placeholder="Enter username">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="password" required
                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                        placeholder="Enter password">
                </div>

                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
                    Invalid username or password!
                </div>

                <button type="submit"
                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-lg hover:shadow-lg transition-all">
                    Login
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="index.html" class="text-purple-600 hover:underline text-sm">‚Üê Back to Website</a>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="max-w-7xl mx-auto hidden">

        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="bg-white rounded-2xl shadow-xl p-4 md:w-64 no-print">
                <h3 class="font-bold text-gray-800 mb-4 text-center">Navigation</h3>
                <nav class="space-y-2">
                    <button onclick="showSection('generator')" id="btn-generator"
                        class="w-full text-left px-4 py-3 rounded-lg bg-purple-100 text-purple-700 font-semibold hover:bg-purple-200 transition-colors">
                        üìù New Receipt
                    </button>
                    <button onclick="showSection('history')" id="btn-history"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-semibold transition-colors">
                        üìã Receipt History
                    </button>
                    <button onclick="showSection('reviews')" id="btn-reviews"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700 font-semibold transition-colors">
                        ‚≠ê Manage Reviews
                    </button>
                </nav>
            </div>

            <div class="flex-1">

                <div id="section-generator">

        <div class="bg-white rounded-t-2xl shadow-xl p-6 no-print">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Admin Panel</h1>
                    <p class="text-gray-600 text-sm mt-1">Receipt & Bill Generator</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="logout()" class="bg-red-500 text-white px-6 py-2 rounded-full hover:bg-red-600 transition-all">
                        Logout
                    </button>
                    <a href="index.html" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:shadow-lg transition-all">
                        Back to Website
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-white shadow-xl p-8 no-print">
            <form id="receipt-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <div class="relative">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Customer Name * 
                            <span class="text-xs text-gray-500 font-normal">(Start typing to see suggestions)</span>
                        </label>
                        <input type="text" id="customer-name" required autocomplete="off"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter or select customer name">
                        <div id="customer-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-purple-400 rounded-lg shadow-xl max-h-60 overflow-y-auto">

                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Contact Number *</label>
                        <input type="tel" id="customer-phone" required
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter contact number">
                        <small class="text-purple-600 text-xs font-semibold">‚úì Customer will be saved automatically for future use</small>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Venue/Occasion *</label>
                        <select id="venue-type" required
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors">
                            <option value="">Select Occasion</option>
                            <option value="Wedding">Wedding Special</option>
                            <option value="Ceremony">Ceremony Special</option>
                            <option value="Birthday">Birthday Party</option>
                            <option value="Get-Together">Get-Together</option>
                            <option value="Haldi">Haldi Special</option>
                            <option value="Reception">Reception</option>
                            <option value="Corporate">Corporate Event</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Event Date *</label>
                        <input type="date" id="event-date" required
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Number of Guests *</label>
                        <input type="number" id="guest-count" required min="1"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter number of guests">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Price Per Plate (‚Çπ) *</label>
                        <input type="number" id="price-per-plate" required min="0" step="0.01"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter price per plate">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Venue Address *</label>
                        <textarea id="venue-address" required rows="2"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter complete venue address"></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 font-semibold">Menu Items/Dishes</label>
                            <button type="button" onclick="toggleAllDishes()" 
                                class="text-sm bg-purple-100 text-purple-600 px-3 py-1 rounded-lg hover:bg-purple-200 transition-colors">
                                Select/Deselect All
                            </button>
                        </div>
                        <div class="border-2 border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Breads</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Wheat Poli"> Wheat Poli</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Jowar Bhakri"> Jowar Bhakri</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Bajra Bhakri"> Bajra Bhakri</label>
                                </div>

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Rice</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Plain Rice"> Plain Rice</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Varan Bhat"> Varan Bhat</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Jeera Rice"> Jeera Rice</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Veg Pulao"> Veg Pulao</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Masala Bhat"> Masala Bhat</label>
                                </div>

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Curries</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Paneer Butter Masala"> Paneer Butter Masala</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Matar Paneer"> Matar Paneer</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Kaju Curry"> Kaju Curry</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Mix Veg"> Mix Veg</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Potato Curry"> Potato Curry</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Chana Masala"> Chana Masala</label>
                                </div>

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Snacks</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Samosa"> Samosa</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Veg Pakoda"> Veg Pakoda</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Bhaji"> Bhaji</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Papad"> Papad</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Dahi Vada"> Dahi Vada</label>
                                </div>

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Sweets</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Shrikhand"> Shrikhand</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Basundi"> Basundi</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Gulabjamun"> Gulabjamun</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Jalebi"> Jalebi</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Puran Poli"> Puran Poli</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Rasgulla"> Rasgulla</label>
                                </div>

                                <div class="space-y-1">
                                    <p class="font-semibold text-purple-600 text-sm">Salad & Drinks</p>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Cucumber Salad"> Cucumber Salad</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Onion Raita"> Onion Raita</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Buttermilk"> Buttermilk</label>
                                    <label class="flex items-center text-sm"><input type="checkbox" class="mr-2 dish-checkbox" value="Lemonade"> Lemonade</label>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Select dishes to include in the menu</p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Additional Items/Services (Optional)</label>
                        <textarea id="additional-items" rows="3"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter additional items and their costs (e.g., Decoration: ‚Çπ5000)"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Advance Payment (‚Çπ)</label>
                        <input type="number" id="advance-payment" min="0" step="0.01" value="0"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors"
                            placeholder="Enter advance payment">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Payment Mode *</label>
                        <select id="payment-mode" required
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition-colors">
                            <option value="">Select Payment Mode</option>
                            <option value="Cash">Cash</option>
                            <option value="Online Transfer">Online Transfer</option>
                            <option value="UPI">UPI</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center pt-4">
                    <button type="submit"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold px-12 py-4 rounded-full hover:shadow-2xl hover:scale-105 transition-all duration-300 text-lg">
                        Generate Document
                    </button>
                </div>
            </form>
        </div>

        <div id="receipt-preview" class="hidden mt-8 bg-white rounded-b-2xl shadow-xl">
            <div class="p-8 receipt">

                <div class="border-4 border-l-8" style="border-color: #7C2D12; padding: 20px;">

                    <div class="flex items-start mb-6">

                        <div class="flex-shrink-0 mr-4">
                            <img src="logor.png" alt="Logo" style="width: 100px; height: 100px; object-fit: contain;">
                        </div>

                        <div class="flex-1 text-center">
                            <h1 class="text-4xl font-bold mb-2" style="color: #7C2D12; font-family: 'Arial Black', sans-serif; letter-spacing: 2px;">SARVADNYA CATERS</h1>
                            <div class="text-sm text-gray-700" style="line-height: 1.8;">
                                <p><strong>At Dahisawali, TQ Mahagaon, Dist. Yavatmal, Marashtra ‚Äì 445204</strong></p>
                                <p><strong>88888034821</strong></p>
                                <p><strong>Pro.pra: Manohar Fating</strong></p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="border-b-2 border-gray-300 pb-2 mb-3">
                            <p class="font-bold text-sm">HEADER: <span id="doc-title" class="font-normal">RECEIPT</span></p>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="border-b border-gray-300 pb-2">
                                <p><strong>Customer Name:</strong> <span id="display-customer-name"></span></p>
                            </div>
                            <div class="border-b border-gray-300 pb-2">
                                <p><strong>Event Name:</strong> <span id="display-venue"></span></p>
                            </div>
                            <div class="border-b border-gray-300 pb-2">
                                <p><strong>Event Date:</strong> <span id="display-event-date"></span></p>
                            </div>
                            <div class="border-b border-gray-300 pb-2">
                                <p><strong>Plate Type:</strong> <span id="display-plate-info"></span></p>
                            </div>
                        </div>
                    </div>

                    <table class="w-full mb-6 border-collapse" style="border: 2px solid #000;">
                        <thead>
                            <tr style="border-bottom: 2px solid #000;">
                                <th class="py-2 px-3 text-left text-sm" style="border-right: 2px solid #000; width: 15%;">Sr. No.</th>
                                <th class="py-2 px-3 text-left text-sm" style="border-right: 2px solid #000; width: 40%;">Dish / Item</th>
                                <th class="py-2 px-3 text-center text-sm" style="border-right: 2px solid #000; width: 20%;">Quantity</th>
                                <th class="py-2 px-3 text-right text-sm" style="width: 25%;">Amount (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody id="billing-items">

                        </tbody>
                    </table>

                    <div class="space-y-2 text-sm mb-6">
                        <div class="flex justify-between">
                            <span><strong>Advance Amount</strong></span>
                            <span id="display-advance" class="font-semibold">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span><strong>Total Amount</strong></span>
                            <span id="display-subtotal" class="font-semibold">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span><strong>Balance Amount</strong></span>
                            <span id="display-balance" class="font-semibold">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between items-end mt-4">
                            <div>
                                <p><strong>Payment Mode:</strong> <span id="display-payment-mode">Cash / UPI / Bank</span></p>
                            </div>
                            <div class="text-right" style="width: 250px;">
                                <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                                <p class="text-sm">Customer Signature</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-100 flex justify-center gap-4 no-print rounded-b-2xl flex-wrap">
                <button onclick="downloadPDF()"
                    class="bg-red-600 text-white font-bold px-6 py-3 rounded-full hover:bg-red-700 transition-colors text-sm md:text-base">
                    üì• Download PDF
                </button>
                <button onclick="saveReceipt()"
                    class="bg-blue-600 text-white font-bold px-6 py-3 rounded-full hover:bg-blue-700 transition-colors text-sm md:text-base">
                    üíæ Save + PDF
                </button>
                <button onclick="editReceipt()"
                    class="bg-yellow-600 text-white font-bold px-6 py-3 rounded-full hover:bg-yellow-700 transition-colors text-sm md:text-base">
                    ‚úèÔ∏è Edit
                </button>
                <button onclick="resetForm()"
                    class="bg-gray-600 text-white font-bold px-6 py-3 rounded-full hover:bg-gray-700 transition-colors text-sm md:text-base">
                    üîÑ New
                </button>
            </div>
        </div>
                </div>

                <div id="section-history" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Receipt History</h2>

                        <div class="mb-6 space-y-4">

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="search-receipt" placeholder="Search by customer name or receipt no..."
                                    class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">From Date</label>
                                    <input type="date" id="filter-date-from"
                                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">To Date</label>
                                    <input type="date" id="filter-date-to"
                                        class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="number" id="filter-amount-min" placeholder="Min Amount (‚Çπ)"
                                    class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                <input type="number" id="filter-amount-max" placeholder="Max Amount (‚Çπ)"
                                    class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                <select id="filter-payment-mode"
                                    class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                                    <option value="">All Payment Modes</option>
                                    <option value="cash">Cash</option>
                                    <option value="online">Online Transfer</option>
                                    <option value="upi">UPI</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="cheque">Cheque</option>
                                </select>
                            </div>

                            <div class="flex gap-4 flex-wrap">
                                <button onclick="applyFilters()"
                                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    üîç Apply Filters
                                </button>
                                <button onclick="clearFilters()"
                                    class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    üîÑ Clear Filters
                                </button>
                                <button onclick="printSelectedReceipts()"
                                    class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                    üñ®Ô∏è Print Selected
                                </button>
                            </div>
                        </div>

                        <div id="receipts-list" class="space-y-4">
                            <p class="text-center text-gray-500 py-8">Loading receipts...</p>
                        </div>
                    </div>
                </div>

                <div id="section-reviews" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Reviews</h2>

                        <div class="mb-6 flex justify-end">
                            <button onclick="loadReviews()"
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                üîÑ Refresh
                            </button>
                        </div>

                        <div id="reviews-list" class="space-y-4">
                            <p class="text-center text-gray-500 py-8">Loading reviews...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gghvwekjmjnhymlqrswk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnaHZ3ZWtqbWpuaHltbHFyc3drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NTAsImV4cCI6MjA3NzE1Mzc1MH0.OR9rQyzcJK_6WInjFPjG7-Zo_Ghpb6bG554-Hm54Ros';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        console.log('‚úÖ Supabase initialized successfully!');

        // Global variables
        let currentReceiptData = null;
        let currentReceiptId = null;

        // Check if user is logged in using Supabase Auth
        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session && !error) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        }

        // Login form handler with Supabase Auth
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-message');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                // Sign in with Supabase Auth using email (username as email)
                const email = username.includes('@') ? username : `${username}@sarvadnyacaterers.local`;
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    throw error;
                }

                errorMsg.classList.add('hidden');
                await checkAuth();
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = error.message || 'Invalid credentials. Please try again.';
                errorMsg.classList.remove('hidden');
                document.getElementById('password').value = '';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });

        // Logout function with Supabase Auth
        async function logout() {
            try {
                await supabase.auth.signOut();
                await checkAuth();
                document.getElementById('login-form').reset();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            }
        }

        // Check auth on page load
        checkAuth();

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                checkAuth();
            } else if (event === 'SIGNED_OUT') {
                checkAuth();
            }
        });

        // Show/Hide Sections
        function showSection(section) {
            document.getElementById('section-generator').classList.add('hidden');
            document.getElementById('section-history').classList.add('hidden');
            document.getElementById('section-reviews').classList.add('hidden');
            document.getElementById('btn-generator').classList.remove('bg-purple-100', 'text-purple-700');
            document.getElementById('btn-history').classList.remove('bg-purple-100', 'text-purple-700');
            document.getElementById('btn-reviews').classList.remove('bg-purple-100', 'text-purple-700');

            if (section === 'generator') {
                document.getElementById('section-generator').classList.remove('hidden');
                document.getElementById('btn-generator').classList.add('bg-purple-100', 'text-purple-700');
            } else if (section === 'history') {
                document.getElementById('section-history').classList.remove('hidden');
                document.getElementById('btn-history').classList.add('bg-purple-100', 'text-purple-700');
                loadReceipts();
            } else if (section === 'reviews') {
                document.getElementById('section-reviews').classList.remove('hidden');
                document.getElementById('btn-reviews').classList.add('bg-purple-100', 'text-purple-700');
                loadReviews();
            }
        }

        // Generate PDF from Receipt
        async function generatePDF() {
            const receiptElement = document.querySelector('.receipt');
            if (!receiptElement) {
                alert('No receipt to convert to PDF!');
                return null;
            }

            try {
                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loadingMsg.textContent = 'üìÑ Generating PDF...';
                document.body.appendChild(loadingMsg);

                // Hide no-print elements temporarily
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');

                // Use html2canvas to capture the receipt
                const canvas = await html2canvas(receiptElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Restore no-print elements
                noPrintElements.forEach(el => el.style.display = '');

                // Create PDF with jsPDF
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Convert PDF to blob
                const pdfBlob = pdf.output('blob');

                // Remove loading message
                document.body.removeChild(loadingMsg);

                return pdfBlob;
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
                return null;
            }
        }

        // Download PDF
        async function downloadPDF() {
            if (!currentReceiptData) {
                alert('Please generate a receipt first!');
                return;
            }

            const pdfBlob = await generatePDF();
            if (pdfBlob) {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Receipt_${currentReceiptData.receiptNo}_${currentReceiptData.customerName.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Save Receipt to Database with PDF
        async function saveReceipt() {
            if (!currentReceiptData) {
                alert('Please generate a receipt first!');
                return;
            }

            try {
                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'fixed top-4 right-4 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
                loadingMsg.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div><span>Saving receipt and generating PDF...</span>';
                document.body.appendChild(loadingMsg);

                // Save customer to database
                await saveCustomer(
                    currentReceiptData.customerName,
                    currentReceiptData.customerPhone,
                    currentReceiptData.venueAddress,
                    currentReceiptData.venueType
                );

                // Generate PDF
                const pdfBlob = await generatePDF();
                let pdfURL = null;

                if (pdfBlob) {
                    // Upload PDF to Supabase Storage
                    const fileName = `${currentReceiptData.receiptNo}_${Date.now()}.pdf`;

                    loadingMsg.querySelector('span').textContent = 'Uploading PDF to cloud...';

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('receipts')
                        .upload(fileName, pdfBlob, {
                            contentType: 'application/pdf',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error('PDF upload error:', uploadError);
                    } else {
                        // Get public URL
                        const { data: urlData } = supabase.storage
                            .from('receipts')
                            .getPublicUrl(fileName);
                        pdfURL = urlData.publicUrl;
                    }
                }

                loadingMsg.querySelector('span').textContent = 'Saving to database...';

                const receiptData = {
                    receipt_no: currentReceiptData.receiptNo,
                    customer_name: currentReceiptData.customerName,
                    customer_phone: currentReceiptData.customerPhone,
                    venue_type: currentReceiptData.venueType,
                    event_date: currentReceiptData.eventDate,
                    guest_count: currentReceiptData.guestCount,
                    price_per_plate: currentReceiptData.pricePerPlate,
                    venue_address: currentReceiptData.venueAddress,
                    selected_dishes: currentReceiptData.selectedDishes || [],
                    additional_items: currentReceiptData.additionalItems,
                    additional_items_list: currentReceiptData.additionalItemsList || [],
                    advance_payment: currentReceiptData.advancePayment,
                    payment_mode: currentReceiptData.paymentMode,
                    subtotal: currentReceiptData.subtotal,
                    balance_due: currentReceiptData.balanceDue,
                    doc_type: currentReceiptData.docType,
                    pdf_url: pdfURL,
                    updated_at: new Date().toISOString()
                };

                if (currentReceiptId) {
                    // Update existing receipt
                    const { error } = await supabase
                        .from('receipts')
                        .update(receiptData)
                        .eq('id', currentReceiptId);

                    if (error) throw error;

                    document.body.removeChild(loadingMsg);

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = '‚úÖ Receipt updated successfully with PDF!';
                    document.body.appendChild(successMsg);
                    setTimeout(() => document.body.removeChild(successMsg), 3000);
                } else {
                    // Save new receipt
                    receiptData.created_at = new Date().toISOString();

                    const { data, error } = await supabase
                        .from('receipts')
                        .insert([receiptData])
                        .select();

                    if (error) throw error;

                    if (data && data.length > 0) {
                        currentReceiptId = data[0].id;
                    }

                    document.body.removeChild(loadingMsg);

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    successMsg.textContent = '‚úÖ Receipt saved successfully with PDF!';
                    document.body.appendChild(successMsg);
                    setTimeout(() => document.body.removeChild(successMsg), 3000);
                }
            } catch (error) {
                console.error('Error saving receipt:', error);
                alert('Error saving receipt: ' + error.message);

                // Try to remove loading message if it exists
                const loadingMsg = document.querySelector('.fixed.top-4.right-4');
                if (loadingMsg) document.body.removeChild(loadingMsg);
            }
        }

        // Save Receipt (Original function - now updated above)
        // Removed duplicate function

        // Edit Receipt
        function editReceipt() {
            if (!currentReceiptData) {
                alert('No receipt to edit!');
                return;
            }

            // Populate form with current data
            document.getElementById('customer-name').value = currentReceiptData.customerName;
            document.getElementById('customer-phone').value = currentReceiptData.customerPhone;
            document.getElementById('venue-type').value = currentReceiptData.venueType;
            document.getElementById('event-date').value = currentReceiptData.eventDate;
            document.getElementById('guest-count').value = currentReceiptData.guestCount;
            document.getElementById('price-per-plate').value = currentReceiptData.pricePerPlate;
            document.getElementById('venue-address').value = currentReceiptData.venueAddress;
            document.getElementById('additional-items').value = currentReceiptData.additionalItems || '';
            document.getElementById('advance-payment').value = currentReceiptData.advancePayment;
            document.getElementById('payment-mode').value = currentReceiptData.paymentMode || 'Cash';

            // Select dishes
            document.querySelectorAll('.dish-checkbox').forEach(cb => cb.checked = false);
            if (currentReceiptData.selectedDishes) {
                currentReceiptData.selectedDishes.forEach(dish => {
                    const checkbox = Array.from(document.querySelectorAll('.dish-checkbox')).find(cb => cb.value === dish);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Hide preview and scroll to form
            document.getElementById('receipt-preview').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load Receipts from Database
        // Load Receipts from Database with filters
        async function loadReceipts() {
            const receiptsList = document.getElementById('receipts-list');
            const searchTerm = document.getElementById('search-receipt').value.toLowerCase();
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const amountMin = document.getElementById('filter-amount-min').value;
            const amountMax = document.getElementById('filter-amount-max').value;
            const paymentMode = document.getElementById('filter-payment-mode').value;

            try {
                receiptsList.innerHTML = '<p class="text-center text-gray-500 py-8">Loading...</p>';

                let query = supabase
                    .from('receipts')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Apply date range filter
                if (dateFrom) {
                    query = query.gte('event_date', dateFrom);
                }
                if (dateTo) {
                    query = query.lte('event_date', dateTo);
                }

                // Apply amount range filter
                if (amountMin) {
                    query = query.gte('subtotal', parseFloat(amountMin));
                }
                if (amountMax) {
                    query = query.lte('subtotal', parseFloat(amountMax));
                }

                // Apply payment mode filter
                if (paymentMode) {
                    query = query.ilike('payment_mode', `%${paymentMode}%`);
                }

                const { data: receipts, error } = await query;

                if (error) throw error;

                if (!receipts || receipts.length === 0) {
                    receiptsList.innerHTML = '<p class="text-center text-gray-500 py-8">No receipts found</p>';
                    return;
                }

                let receiptsHTML = '';
                receipts.forEach(receipt => {
                    const matchesSearch = !searchTerm || 
                        receipt.customer_name.toLowerCase().includes(searchTerm) ||
                        receipt.receipt_no.toLowerCase().includes(searchTerm) ||
                        (receipt.customer_phone && receipt.customer_phone.includes(searchTerm));

                    if (!matchesSearch) return;

                    const createdDate = receipt.created_at ? new Date(receipt.created_at).toLocaleString('en-IN') : 'N/A';
                    const hasPDF = receipt.pdf_url ? true : false;

                    receiptsHTML += `
                        <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-400 transition-colors">
                            <div class="flex items-start gap-3">
                                <input type="checkbox" class="receipt-checkbox mt-1 w-5 h-5" data-receipt-id="${receipt.id}">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg text-gray-800">${receipt.customer_name}</h3>
                                            <p class="text-sm text-gray-600">Receipt No: <span class="font-semibold">${receipt.receipt_no}</span></p>
                                            <p class="text-sm text-gray-600">Phone: ${receipt.customer_phone}</p>
                                            <p class="text-sm text-gray-600">Occasion: ${receipt.venue_type}</p>
                                            <p class="text-sm text-gray-600">Event Date: ${formatDate(receipt.event_date)}</p>
                                            ${receipt.payment_mode ? `<p class="text-sm text-gray-600">Payment: ${receipt.payment_mode}</p>` : ''}
                                            ${hasPDF ? '<p class="text-xs text-green-600 font-semibold mt-1">üìÑ PDF Available</p>' : '<p class="text-xs text-gray-400 mt-1">üìÑ No PDF</p>'}
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xl font-bold text-purple-600">${formatCurrency(receipt.subtotal)}</p>
                                            <p class="text-xs text-green-600">Advance: ${formatCurrency(receipt.advance_payment || 0)}</p>
                                            <p class="text-xs text-red-600">Balance: ${formatCurrency(receipt.balance_due || 0)}</p>
                                            <p class="text-xs text-gray-500 mt-1">${createdDate}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-3 flex-wrap">
                                        <button onclick="viewReceipt('${receipt.id}')"
                                            class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                            üëÅÔ∏è View
                                        </button>
                                        ${hasPDF ? `<a href="${receipt.pdf_url}" target="_blank" class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm text-center">üì• PDF</a>` : ''}
                                        <button onclick="loadReceiptForEdit('${receipt.id}')"
                                            class="flex-1 bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 transition-colors text-sm">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button onclick="deleteReceipt('${receipt.id}', '${receipt.pdf_url || ''}')"
                                            class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                receiptsList.innerHTML = receiptsHTML || '<p class="text-center text-gray-500 py-8">No receipts match your filters</p>';
            } catch (error) {
                console.error('Error loading receipts:', error);
                receiptsList.innerHTML = '<p class="text-center text-red-500 py-8">Error loading receipts</p>';
            }
        }

        // Apply filters
        function applyFilters() {
            loadReceipts();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('search-receipt').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-amount-min').value = '';
            document.getElementById('filter-amount-max').value = '';
            document.getElementById('filter-payment-mode').value = '';
            loadReceipts();
        }

        // Export all receipts to JSON
        async function exportReceipts() {
            try {
                const { data: receipts, error } = await supabase
                    .from('receipts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const dataStr = JSON.stringify(receipts, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `receipts_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);

                alert('‚úÖ Backup downloaded successfully!');
            } catch (error) {
                console.error('Error exporting receipts:', error);
                alert('‚ùå Error creating backup');
            }
        }

        // Import receipts from JSON
        async function importReceipts(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const receipts = JSON.parse(e.target.result);

                        if (!Array.isArray(receipts)) {
                            alert('‚ùå Invalid backup file format');
                            return;
                        }

                        const confirmed = confirm(`Are you sure you want to restore ${receipts.length} receipts? This will not delete existing receipts.`);
                        if (!confirmed) return;

                        for (const receipt of receipts) {
                            delete receipt.id; // Remove ID to create new entries
                            await supabase.from('receipts').insert(receipt);
                        }

                        alert('‚úÖ Receipts restored successfully!');
                        loadReceipts();
                    } catch (error) {
                        console.error('Error parsing backup file:', error);
                        alert('‚ùå Error reading backup file');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing receipts:', error);
                alert('‚ùå Error restoring backup');
            }
        }

        // Print selected receipts
        async function printSelectedReceipts() {
            const checkboxes = document.querySelectorAll('.receipt-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one receipt to print');
                return;
            }

            const receiptIds = Array.from(checkboxes).map(cb => cb.dataset.receiptId);

            for (const id of receiptIds) {
                await viewReceipt(id);
                // Wait for DOM to render the receipt preview
                await new Promise(resolve => setTimeout(resolve, 500));
                // Print the current receipt
                window.print();
                // Wait before loading next receipt
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // View Receipt
        async function viewReceipt(receiptId) {
            try {
                const { data: receipt, error } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('id', receiptId)
                    .single();

                if (error) throw error;

                if (!receipt) {
                    alert('Receipt not found!');
                    return;
                }

                // Convert snake_case to camelCase for compatibility with existing functions
                currentReceiptData = {
                    receiptNo: receipt.receipt_no,
                    customerName: receipt.customer_name,
                    customerPhone: receipt.customer_phone,
                    venueType: receipt.venue_type,
                    eventDate: receipt.event_date,
                    guestCount: receipt.guest_count,
                    pricePerPlate: receipt.price_per_plate,
                    venueAddress: receipt.venue_address,
                    selectedDishes: receipt.selected_dishes,
                    additionalItems: receipt.additional_items,
                    additionalItemsList: receipt.additional_items_list,
                    advancePayment: receipt.advance_payment,
                    paymentMode: receipt.payment_mode,
                    subtotal: receipt.subtotal,
                    balanceDue: receipt.balance_due,
                    docType: receipt.doc_type
                };
                currentReceiptId = receiptId;

                // Populate preview with saved data
                populateReceiptPreview(currentReceiptData);

                // Show preview and scroll to it
                document.getElementById('receipt-preview').classList.remove('hidden');
                showSection('generator');
                setTimeout(() => {
                    document.getElementById('receipt-preview').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } catch (error) {
                console.error('Error viewing receipt:', error);
                alert('Error loading receipt');
            }
        }

        // Load Receipt for Edit
        async function loadReceiptForEdit(receiptId) {
            try {
                const { data: receipt, error } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('id', receiptId)
                    .single();

                if (error) throw error;

                if (!receipt) {
                    alert('Receipt not found!');
                    return;
                }

                // Convert snake_case to camelCase
                currentReceiptData = {
                    receiptNo: receipt.receipt_no,
                    customerName: receipt.customer_name,
                    customerPhone: receipt.customer_phone,
                    venueType: receipt.venue_type,
                    eventDate: receipt.event_date,
                    guestCount: receipt.guest_count,
                    pricePerPlate: receipt.price_per_plate,
                    venueAddress: receipt.venue_address,
                    selectedDishes: receipt.selected_dishes,
                    additionalItems: receipt.additional_items,
                    additionalItemsList: receipt.additional_items_list,
                    advancePayment: receipt.advance_payment,
                    paymentMode: receipt.payment_mode,
                    subtotal: receipt.subtotal,
                    balanceDue: receipt.balance_due,
                    docType: receipt.doc_type
                };
                currentReceiptId = receiptId;

                // Switch to generator section
                showSection('generator');

                // Populate form
                editReceipt();
            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('Error loading receipt for edit');
            }
        }

        // Delete Receipt
        async function deleteReceipt(receiptId, pdfURL) {
            if (!confirm('Are you sure you want to delete this receipt? This action cannot be undone.')) {
                return;
            }

            try {
                // Delete PDF from Supabase Storage if exists
                if (pdfURL) {
                    try {
                        // Extract filename from URL
                        const urlParts = pdfURL.split('/');
                        const fileName = urlParts[urlParts.length - 1];

                        const { error: deleteError } = await supabase.storage
                            .from('receipts')
                            .remove([fileName]);

                        if (deleteError) {
                            console.error('Error deleting PDF:', deleteError);
                        }
                    } catch (error) {
                        console.error('Error deleting PDF:', error);
                        // Continue with receipt deletion even if PDF deletion fails
                    }
                }

                // Delete receipt from Supabase
                const { error } = await supabase
                    .from('receipts')
                    .delete()
                    .eq('id', receiptId);

                if (error) throw error;

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successMsg.textContent = '‚úÖ Receipt and PDF deleted successfully!';
                document.body.appendChild(successMsg);
                setTimeout(() => document.body.removeChild(successMsg), 3000);

                loadReceipts();
            } catch (error) {
                console.error('Error deleting receipt:', error);
                alert('Error deleting receipt: ' + error.message);
            }
        }

        // Populate Receipt Preview with data
        function populateReceiptPreview(data) {
            const docTitles = {
                receipt: 'RECEIPT',
                bill: 'INVOICE'
            };

            document.getElementById('doc-title').textContent = docTitles[data.docType];
            document.getElementById('display-event-date').textContent = formatDate(data.eventDate);
            document.getElementById('display-venue').textContent = data.venueType;
            document.getElementById('display-customer-name').textContent = data.customerName;

            // Display plate info (guest count and price per plate)
            const plateInfo = `${data.guestCount} Plates @ ${formatCurrency(data.pricePerPlate)} per plate`;
            document.getElementById('display-plate-info').textContent = plateInfo;

            // Populate billing items
            const billingItems = document.getElementById('billing-items');
            let itemHtml = '';
            let srNo = 1;

            // Main catering service
            itemHtml += `
                <tr style="border-bottom: 2px solid #000;">
                    <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;">${srNo++}</td>
                    <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;">Catering Services - ${data.venueType}</td>
                    <td class="py-2 px-3 text-center text-sm" style="border-right: 2px solid #000;">${data.guestCount} Plates</td>
                    <td class="py-2 px-3 text-right text-sm font-semibold">${formatCurrency(data.guestCount * data.pricePerPlate)}</td>
                </tr>
            `;

            // Menu items as sub-items
            if (data.selectedDishes && data.selectedDishes.length > 0) {
                itemHtml += `
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;"></td>
                        <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;" colspan="3">
                            <strong>Menu Items:</strong><br>
                            ${data.selectedDishes.map(dish => `‚Ä¢ ${dish}`).join('<br>')}
                        </td>
                    </tr>
                `;
            }

            // Additional items
            if (data.additionalItemsList && data.additionalItemsList.length > 0) {
                data.additionalItemsList.forEach(item => {
                    itemHtml += `
                        <tr style="border-bottom: 2px solid #000;">
                            <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;">${srNo++}</td>
                            <td class="py-2 px-3 text-sm" style="border-right: 2px solid #000;">${item.name}</td>
                            <td class="py-2 px-3 text-center text-sm" style="border-right: 2px solid #000;">1</td>
                            <td class="py-2 px-3 text-right text-sm font-semibold">${formatCurrency(item.cost)}</td>
                        </tr>
                    `;
                });
            }

            billingItems.innerHTML = itemHtml;

            // Update totals
            document.getElementById('display-subtotal').textContent = formatCurrency(data.subtotal);
            document.getElementById('display-advance').textContent = formatCurrency(data.advancePayment);
            document.getElementById('display-balance').textContent = formatCurrency(data.balanceDue);
            document.getElementById('display-payment-mode').textContent = data.paymentMode || 'Cash / UPI / Bank';
        }

        // Search functionality
        document.getElementById('search-receipt').addEventListener('input', function() {
            loadReceipts();
        });

        // Toggle all dishes
        function toggleAllDishes() {
            const checkboxes = document.querySelectorAll('.dish-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        // Generate Receipt Number
        // Generate Receipt Number with atomic sequence tracking
        async function generateReceiptNo() {
            try {
                // Use atomic increment to prevent race conditions
                // This performs UPDATE ... RETURNING in a single operation
                const { data: sequence, error: updateError } = await supabase
                    .rpc('increment_receipt_sequence');

                if (updateError) {
                    console.error('Error incrementing sequence:', updateError);
                    // Fallback to random number with fixed Math.random()
                    const date = new Date();
                    const year = date.getFullYear().toString().substr(-2);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const random = Math.floor(Math.random() * 9000) + 1000; // Fixed: proper random 1000-9999
                    return `SC${year}${month}${random}`;
                }

                // If RPC doesn't exist, fall back to traditional method with better handling
                if (!sequence) {
                    const { data: seq, error: fetchError } = await supabase
                        .from('receipt_sequence')
                        .select('*')
                        .eq('id', 1)
                        .single();

                    if (fetchError) {
                        const date = new Date();
                        const year = date.getFullYear().toString().substr(-2);
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const random = Math.floor(Math.random() * 9000) + 1000; // Fixed: proper random 1000-9999
                        return `SC${year}${month}${random}`;
                    }

                    const nextNumber = seq.current_number + 1;
                    const receiptNo = `${seq.prefix}${String(nextNumber).padStart(6, '0')}`;

                    // Update sequence (still has race condition but better than before)
                    await supabase
                        .from('receipt_sequence')
                        .update({ 
                            current_number: nextNumber,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', 1);

                    return receiptNo;
                }

                // Use the atomically incremented number from RPC
                const receiptNo = `SC${String(sequence).padStart(6, '0')}`;
                return receiptNo;
            } catch (error) {
                console.error('Error in generateReceiptNo:', error);
                // Fallback with fixed Math.random()
                const date = new Date();
                const year = date.getFullYear().toString().substr(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 9000) + 1000; // Fixed: proper random 1000-9999
                return `SC${year}${month}${random}`;
            }
        }

        // Format Date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Format Currency
        function formatCurrency(amount) {
            return `‚Çπ${parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // ===== CUSTOMER DATABASE FUNCTIONS =====

        let allCustomers = [];

        // Load all customers for autocomplete
        async function loadCustomers() {
            try {
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                allCustomers = customers || [];
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Show customer dropdown with filtered results
        function showCustomerDropdown(searchText) {
            const dropdown = document.getElementById('customer-dropdown');
            const input = document.getElementById('customer-name');

            if (!searchText || searchText.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            const filtered = allCustomers.filter(customer => 
                customer.name.toLowerCase().includes(searchText.toLowerCase()) ||
                customer.phone.includes(searchText)
            );

            if (filtered.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = '';
            filtered.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 transition-colors';
                item.innerHTML = `
                    <div class="font-semibold text-gray-800">${customer.name}</div>
                    <div class="text-sm text-gray-600">üìû ${customer.phone}</div>
                    <div class="text-xs text-purple-600">üìç ${customer.address || 'No address'} | üìÖ ${customer.total_bookings} booking(s)</div>
                `;
                item.onclick = () => selectCustomer(customer);
                dropdown.appendChild(item);
            });

            dropdown.classList.remove('hidden');
        }

        // Select a customer from dropdown
        function selectCustomer(customer) {
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-phone').value = customer.phone;
            document.getElementById('venue-address').value = customer.address || '';
            document.getElementById('customer-dropdown').classList.add('hidden');
        }

        // Handle customer name input
        document.getElementById('customer-name').addEventListener('input', function(e) {
            showCustomerDropdown(e.target.value);
        });

        // Handle focus - show all customers
        document.getElementById('customer-name').addEventListener('focus', function(e) {
            if (allCustomers.length > 0 && !e.target.value) {
                showCustomerDropdown('a'); // Show all
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('customer-dropdown');
            const input = document.getElementById('customer-name');
            if (e.target !== input && e.target !== dropdown) {
                dropdown.classList.add('hidden');
            }
        });

        // Load customers on page load
        loadCustomers();
        async function saveCustomer(name, phone, address, eventType) {
            try {
                // Check if customer exists
                const { data: existing, error: fetchError } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();

                if (existing) {
                    // Update existing customer
                    const { error: updateError } = await supabase
                        .from('customers')
                        .update({
                            name,
                            address,
                            last_event_type: eventType,
                            total_bookings: existing.total_bookings + 1,
                            updated_at: new Date().toISOString()
                        })
                        .eq('phone', phone);

                    if (updateError) throw updateError;
                } else {
                    // Insert new customer
                    const { error: insertError } = await supabase
                        .from('customers')
                        .insert({
                            name,
                            phone,
                            address,
                            last_event_type: eventType,
                            total_bookings: 1
                        });

                    if (insertError) throw insertError;
                }

                // Reload customer list
                await loadCustomers();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        // Handle Form Submission
        document.getElementById('receipt-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get form values
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const venueType = document.getElementById('venue-type').value;
            const eventDate = document.getElementById('event-date').value;
            const guestCount = parseInt(document.getElementById('guest-count').value);
            const pricePerPlate = parseFloat(document.getElementById('price-per-plate').value);
            const venueAddress = document.getElementById('venue-address').value;
            const additionalItems = document.getElementById('additional-items').value;
            const advancePayment = parseFloat(document.getElementById('advance-payment').value) || 0;
            const paymentMode = document.getElementById('payment-mode').value;
            const docType = 'bill';

            // Get selected dishes
            const selectedDishes = [];
            document.querySelectorAll('.dish-checkbox:checked').forEach(checkbox => {
                selectedDishes.push(checkbox.value);
            });

            // Calculate totals
            const mainAmount = guestCount * pricePerPlate;
            let subtotal = mainAmount;

            // Parse additional items
            const additionalItemsList = [];
            if (additionalItems.trim()) {
                const lines = additionalItems.split('\n');
                lines.forEach(line => {
                    const match = line.match(/(.+?):\s*‚Çπ?\s*(\d+\.?\d*)/);
                    if (match) {
                        const itemName = match[1].trim();
                        const itemCost = parseFloat(match[2]);
                        additionalItemsList.push({ name: itemName, cost: itemCost });
                        subtotal += itemCost;
                    }
                });
            }

            // Calculate balance due
            const balanceDue = subtotal - advancePayment;

            // Generate receipt number with sequence
            const receiptNo = await generateReceiptNo();

            // Store current receipt data
            currentReceiptData = {
                receiptNo,
                customerName,
                customerPhone,
                venueType,
                eventDate,
                guestCount,
                pricePerPlate,
                venueAddress,
                additionalItems,
                additionalItemsList,
                advancePayment,
                paymentMode,
                docType,
                selectedDishes,
                subtotal,
                balanceDue
            };

            // Populate receipt preview with data
            populateReceiptPreview(currentReceiptData);

            // Show receipt preview
            document.getElementById('receipt-preview').classList.remove('hidden');

            // Scroll to receipt
            document.getElementById('receipt-preview').scrollIntoView({ behavior: 'smooth' });
        });

        // Reset Form
        function resetForm() {
            document.getElementById('receipt-form').reset();
            document.getElementById('receipt-preview').classList.add('hidden');
            currentReceiptData = null;
            currentReceiptId = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Set today's date as default
        document.getElementById('event-date').valueAsDate = new Date();

        // ===== REVIEW MANAGEMENT FUNCTIONS =====

        // Load all reviews from Supabase
        async function loadReviews() {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '<p class="text-center text-gray-500 py-8">Loading reviews...</p>';

            try {
                const { data: reviews, error } = await supabase
                    .from('reviews')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) throw error;

                if (!reviews || reviews.length === 0) {
                    reviewsList.innerHTML = '<p class="text-center text-gray-500 py-8">No reviews found.</p>';
                    return;
                }

                displayReviews(reviews);

            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewsList.innerHTML = '<p class="text-center text-red-500 py-8">Error loading reviews: ' + error.message + '</p>';
            }
        }

        // Display reviews in the list
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviews-list');

            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p class="text-center text-gray-500 py-8">No reviews found.</p>';
                return;
            }

            reviewsList.innerHTML = reviews.map(review => `
                <div class="bg-gray-50 rounded-lg p-6 border-2 border-gray-200 hover:border-purple-300 transition-colors">
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="font-bold text-lg text-gray-800">${review.name}</h3>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-yellow-500 text-lg">
                                    ${'‚≠ê'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                                </span>
                                <span class="text-gray-600 text-sm">(${review.rating}/5)</span>
                            </div>
                            <p class="text-gray-700 mb-3">"${review.review}"</p>
                            <p class="text-sm text-gray-500">
                                üìÖ ${new Date(review.timestamp).toLocaleDateString('en-IN', { 
                                    day: 'numeric', 
                                    month: 'short', 
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>

                        <div class="flex items-start">
                            <button onclick="deleteReview('${review.id}')"
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-semibold">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete a review
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('reviews')
                    .delete()
                    .eq('id', reviewId);

                if (error) throw error;

                showNotification('üóëÔ∏è Review deleted successfully!', 'success');
                loadReviews();
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('Error deleting review: ' + error.message);
            }
        }

        // Helper function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 3000);
        }
    </script>
</body>
</html>

